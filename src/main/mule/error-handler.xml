<?xml version="1.0" encoding="UTF-8"?>
<mule xmlns="http://www.mulesoft.org/schema/mule/core"
      xmlns:doc="http://www.mulesoft.org/schema/mule/documentation"
      xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
      xmlns:ee="http://www.mulesoft.org/schema/mule/ee/core"
      xsi:schemaLocation="
http://www.mulesoft.org/schema/mule/core http://www.mulesoft.org/schema/mule/core/current/mule.xsd
http://www.mulesoft.org/schema/mule/ee/core http://www.mulesoft.org/schema/mule/ee/core/current/mule-ee.xsd">

    <!-- Common Error Handler -->
    <error-handler name="common-error-handler">
        <!-- Google Sheets connectivity errors -->
        <on-error-propagate type="GOOGLE-SHEETS:CONNECTIVITY" logException="true">
            <logger level="ERROR" message="Google Sheets connectivity error: #[error.description]" category="com.company.api.error"/>
            <ee:transform>
                <ee:message>
                    <ee:set-payload><![CDATA[%dw 2.0
output application/json
---
{
    code: "CONNECTIVITY_ERROR",
    message: "Failed to connect to Google Sheets: " ++ (error.description default "Unknown error"),
    timestamp: now(),
    details: error.detailedDescription default ""
}]]></ee:set-payload>
                </ee:message>
            </ee:transform>
            <set-variable variableName="httpStatus" value="503"/>
            <set-variable variableName="outboundHeaders" value="#[{'Content-Type': 'application/json'}]"/>
        </on-error-propagate>
        
        <!-- Google Sheets invalid request errors -->
        
        <!-- Validation errors -->
        
        <!-- Generic error handler -->
        <on-error-propagate type="ANY" logException="true">
            <logger level="ERROR" message="Unhandled error: #[error.description]" category="com.company.api.error"/>
            <ee:transform>
                <ee:message>
                    <ee:set-payload><![CDATA[%dw 2.0
output application/json
---
{
    code: error.errorType.identifier default "INTERNAL_SERVER_ERROR",
    message: error.description default "An unexpected error occurred",
    timestamp: now(),
    details: error.detailedDescription default ""
}]]></ee:set-payload>
                </ee:message>
            </ee:transform>
            <set-variable variableName="httpStatus" value="500"/>
            <set-variable variableName="outboundHeaders" value="#[{'Content-Type': 'application/json'}]"/>
        </on-error-propagate>
    </error-handler>

</mule>